<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Orthogonal Trajectory Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d47a1 0%, #311b92 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 30px;
            color: white;
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .logo i {
            color: #7e57c2;
            font-size: 2.5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .section-title {
            color: #1a237e;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .visualization-container {
            height: 300px;
            background: linear-gradient(135deg, #f5f5f5 0%, #ede7f6 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 25px;
            border: 3px solid #d1c4e9;
        }

        .equation-display {
            text-align: center;
            width: 90%;
        }

        .main-equation {
            font-size: 1.8rem;
            color: #5c6bc0;
            margin-bottom: 10px;
            font-weight: bold;
            padding: 10px;
            background: #e8eaf6;
            border-radius: 8px;
        }

        .orthogonal-equation {
            font-size: 1.5rem;
            color: #ef5350;
            font-weight: bold;
            padding: 10px;
            background: #ffebee;
            border-radius: 8px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #1a237e;
            font-size: 1.1rem;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1c4e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .input-field:focus {
            outline: none;
            border-color: #5c6bc0;
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.2);
            background: white;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .suggestion-btn {
            background: #e8eaf6;
            border: 2px solid #5c6bc0;
            color: #5c6bc0;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .suggestion-btn:hover {
            background: #5c6bc0;
            color: white;
            transform: translateY(-2px);
        }

        .equation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .equation-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e8eaf6;
        }

        .equation-box h4 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .eq-examples {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .eq-example {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .eq-example:hover {
            background: #f0f0f0;
        }

        .eq-text {
            font-family: 'Cambria Math', serif;
            font-size: 1rem;
        }

        .eq-btn {
            background: #5c6bc0;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, #1a237e 0%, #5c6bc0 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(92, 107, 192, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(92, 107, 192, 0.4);
        }

        .solution-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .solution-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #e8eaf6;
        }

        .solution-box h3 {
            color: #1a237e;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #5c6bc0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step {
            margin-bottom: 15px;
            padding-left: 20px;
            border-left: 3px solid #5c6bc0;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 0 8px 8px 0;
        }

        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #1a237e 0%, #5c6bc0 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .math-equation {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #d1c4e9;
            font-size: 1.1rem;
            text-align: center;
            font-family: 'Cambria Math', serif;
            background: #f8f9fa;
            overflow-x: auto;
        }

        .graph-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .graph-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            height: 350px;
            border: 2px solid #e8eaf6;
        }

        .back-home-btn {
            background: linear-gradient(135deg, #1a237e 0%, #5c6bc0 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 30px auto;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(92, 107, 192, 0.3);
        }

        .back-home-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(92, 107, 192, 0.4);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #ef5350;
            display: none;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #4caf50;
            display: none;
        }

        .coeff-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 10px;
        }

        .coeff-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .coeff-label {
            font-weight: bold;
            color: #5c6bc0;
            font-size: 0.9rem;
        }

        .coeff-input {
            padding: 8px;
            border: 2px solid #d1c4e9;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .derivative-display {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Cambria Math', serif;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid #5c6bc0;
        }

        @media (max-width: 768px) {
            .graph-stack {
                grid-template-columns: 1fr;
            }
            .equation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Front Page -->
    <div id="frontPage">
        <header class="header">
            <div class="logo">
                <i class="fas fa-infinity"></i>
                <span>Universal Orthogonal Trajectory Calculator</span>
            </div>
        </header>

        <div class="container">
            <h2 class="section-title">
                <i class="fas fa-calculator"></i> Calculate Orthogonal Trajectories for Any Function
            </h2>
            
            <div class="visualization-container">
                <div class="equation-display">
                    <div class="main-equation" id="mainEquation">\[ y = f(x) \]</div>
                    <div class="orthogonal-equation" id="orthogonalEquation">\[ \text{Orthogonal: } y = \int -\frac{1}{f'(x)} dx + C \]</div>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <!-- Equation Input -->
            <div class="input-group">
                <label class="input-label" for="equation">
                    <i class="fas fa-square-root-alt"></i> Enter Any Mathematical Function f(x)
                </label>
                <input type="text" id="equation" class="input-field" 
                       placeholder="Examples: y = 2x² + 3x + 1, y = sin(2x), y = e^(3x), y = ln(x), y = 1/x²">
                <div class="suggestions">
                    <button class="suggestion-btn" onclick="insertEquation('y = 2x^2 + 3x + 1')">Quadratic</button>
                    <button class="suggestion-btn" onclick="insertEquation('y = 3x + 2')">Linear</button>
                    <button class="suggestion-btn" onclick="insertEquation('y = x^3 - 2x^2 + x - 1')">Cubic</button>
                    <button class="suggestion-btn" onclick="insertEquation('y = sin(2x)')">Trigonometric</button>
                </div>
            </div>

            <!-- Coefficient Inputs -->
            <div class="coeff-inputs" id="coeffInputs" style="display: none;">
                <!-- Dynamic coefficient inputs will be added here -->
            </div>

            <!-- Equation Examples Grid -->
            <div class="equation-grid">
                <!-- Polynomial Functions -->
                <div class="equation-box">
                    <h4><i class="fas fa-chart-line"></i> Polynomial Functions</h4>
                    <div class="eq-examples">
                        <div class="eq-example">
                            <span class="eq-text">y = a·x² + b·x + p</span>
                            <button class="eq-btn" onclick="insertEquation('y = 2x^2 + 3x + 1')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = a·x³ + b·x² + p·x + d</span>
                            <button class="eq-btn" onclick="insertEquation('y = x^3 - 2x^2 + x - 1')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = a·x + b</span>
                            <button class="eq-btn" onclick="insertEquation('y = 3x + 2')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = xⁿ</span>
                            <button class="eq-btn" onclick="insertEquation('y = x^3')">Use</button>
                        </div>
                    </div>
                </div>

                <!-- Trigonometric Functions -->
                <div class="equation-box">
                    <h4><i class="fas fa-wave-square"></i> Trigonometric Functions</h4>
                    <div class="eq-examples">
                        <div class="eq-example">
                            <span class="eq-text">y = a·sin(b·x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = 2*sin(3*x)')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = a·cos(b·x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = 3*cos(2*x)')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = a·tan(b·x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = tan(x)')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">sin(x) + cos(x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = sin(x) + cos(x)')">Use</button>
                        </div>
                    </div>
                </div>

                <!-- Exponential & Logarithmic -->
                <div class="equation-box">
                    <h4><i class="fas fa-chart-bar"></i> Exponential & Logarithmic</h4>
                    <div class="eq-examples">
                        <div class="eq-example">
                            <span class="eq-text">y = aˣ</span>
                            <button class="eq-btn" onclick="insertEquation('y = 2^x')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = e^(a·x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = e^(2*x)')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = a·ln(b·x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = 2*ln(3*x)')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = log_a(b·x)</span>
                            <button class="eq-btn" onclick="insertEquation('y = log_2(x)')">Use</button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Functions -->
                <div class="equation-box">
                    <h4><i class="fas fa-shapes"></i> Advanced Functions</h4>
                    <div class="eq-examples">
                        <div class="eq-example">
                            <span class="eq-text">y = a/xⁿ</span>
                            <button class="eq-btn" onclick="insertEquation('y = 1/x^2')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y = a/(b·x + p)</span>
                            <button class="eq-btn" onclick="insertEquation('y = 2/(3*x+1)')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">x² + y² = r²</span>
                            <button class="eq-btn" onclick="insertEquation('x^2 + y^2 = 25')">Use</button>
                        </div>
                        <div class="eq-example">
                            <span class="eq-text">y² = 4·a·x</span>
                            <button class="eq-btn" onclick="insertEquation('y^2 = 4*x')">Use</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="submit-btn" id="calculateBtn">
                <i class="fas fa-bolt"></i> Calculate Orthogonal Trajectory
            </button>
        </div>
    </div>

    <!-- Backend Page -->
    <div id="backendPage" style="display: none;">
        <div class="solution-container">
            <!-- Original Equation -->
            <div class="solution-box">
                <h3><i class="fas fa-equation"></i> Original Function</h3>
                <div class="math-equation" id="originalEquationDisplay">
                    \[ y = f(x) \]
                </div>
                <div id="paramsDisplay"></div>
            </div>

            <!-- Differentiation Steps -->
            <div class="solution-box">
                <h3><i class="fas fa-calculator"></i> Differentiation Process</h3>
                <div class="derivative-display" id="derivativeDisplay">
                    \[ \frac{dy}{dx} = f'(x) \]
                </div>
                <div id="differentiationSteps">
                    <!-- Differentiation steps will be added here -->
                </div>
            </div>

            <!-- Orthogonal Trajectory Steps -->
            <div class="solution-box">
                <h3><i class="fas fa-list-ol"></i> Step-by-Step Solution for Orthogonal Trajectory</h3>
                <div id="orthogonalSteps">
                    <!-- Orthogonal trajectory steps will be added here -->
                </div>
            </div>

            <!-- Final Orthogonal Trajectory -->
            <div class="solution-box">
                <h3><i class="fas fa-check-circle"></i> Orthogonal Trajectory Solution</h3>
                <div class="math-equation" id="finalAnswer">
                    \[ \text{Orthogonal Trajectory} \]
                </div>
                <div id="integrationConstant" style="margin-top: 15px; color: #666; font-style: italic;">
                    Note: C is the integration constant representing family of orthogonal curves
                </div>
            </div>

            <!-- Graphs -->
            <div class="solution-box">
                <h3><i class="fas fa-chart-line"></i> Graphical Visualization</h3>
                <div class="graph-stack">
                    <div class="graph-container" id="originalGraph">
                        Original Function
                    </div>
                    <div class="graph-container" id="orthogonalGraph">
                        Orthogonal Trajectories
                    </div>
                    <div class="graph-container" id="combinedGraph">
                        Combined View
                    </div>
                </div>
            </div>

            <button class="back-home-btn" id="backHomeBtn">
                <i class="fas fa-arrow-left"></i> Back to Calculator
            </button>
        </div>
    </div>

    <script>
        // ==================== UNIVERSAL ORTHOGONAL TRAJECTORY CALCULATOR ====================
        
        // DOM Elements
        const frontPage = document.getElementById('frontPage');
        const backendPage = document.getElementById('backendPage');
        const equationInput = document.getElementById('equation');
        const calculateBtn = document.getElementById('calculateBtn');
        const backHomeBtn = document.getElementById('backHomeBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const coeffInputs = document.getElementById('coeffInputs');

        // Equation patterns and solutions with explicit multiplication signs
        const equationPatterns = {
            // ========== POLYNOMIAL FUNCTIONS ==========
            'quadratic': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\*?\s*x\s*\^\s*2\s*([+-]\s*\d*\.?\d*)\s*\*?\s*x\s*([+-]\s*\d*\.?\d*)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\*?\s*x\s*\^\s*2/i,
                template: 'y = a·x² + b·x + p',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    b: parseFloat(match[2].replace(/\s/g, '')) || 0,
                    p: parseFloat(match[3].replace(/\s/g, '')) || 0
                }),
                derivative: (coeff) => {
                    const aTerm = coeff.a === 1 ? '' : coeff.a === -1 ? '-' : coeff.a;
                    const bTerm = coeff.b === 1 ? '' : coeff.b === -1 ? '-' : coeff.b;
                    return `2 \\cdot ${aTerm}x + ${bTerm}`;
                },
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}x^2 + ${coeff.b}x + ${coeff.p} \\]`,
                    `Apply power rule: \\[ \\frac{d}{dx}(x^n) = n \\cdot x^{n-1} \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.a}x^2) = 2 \\cdot ${coeff.a}x^{2-1} = ${2 * coeff.a}x \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.b}x) = ${coeff.b} \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.p}) = 0 \\]`,
                    `Combine: \\[ \\frac{dy}{dx} = ${2 * coeff.a}x + ${coeff.b} \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{1}{${2 * coeff.a}x + ${coeff.b}}`,
                solution: (coeff, C) => `y = -\\frac{1}{${2 * coeff.a}} \\ln|${2 * coeff.a}x + ${coeff.b}| + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = ${2 * coeff.a}x + ${coeff.b} \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{1}{${2 * coeff.a}x + ${coeff.b}} \\]`,
                    `Separate variables: \\[ dy = -\\frac{dx}{${2 * coeff.a}x + ${coeff.b}} \\]`,
                    `Integrate both sides: \\[ \\int dy = -\\int \\frac{dx}{${2 * coeff.a}x + ${coeff.b}} \\]`,
                    `Let \\[ u = ${2 * coeff.a}x + ${coeff.b}, \\quad du = ${2 * coeff.a}dx \\]`,
                    `\\[ \\int dy = -\\frac{1}{${2 * coeff.a}} \\int \\frac{du}{u} \\]`,
                    `\\[ y = -\\frac{1}{${2 * coeff.a}} \\ln|u| + ${C} \\]`,
                    `\\[ y = -\\frac{1}{${2 * coeff.a}} \\ln|${2 * coeff.a}x + ${coeff.b}| + ${C} \\]`
                ]
            },

            'linear': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\*?\s*x\s*([+-]\s*\d*\.?\d*)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\*?\s*x/i,
                template: 'y = a·x + b',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    b: parseFloat(match[2].replace(/\s/g, '')) || 0
                }),
                derivative: (coeff) => `${coeff.a}`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}x + ${coeff.b} \\]`,
                    `Apply power rule: \\[ \\frac{d}{dx}(x) = 1 \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.a}x) = ${coeff.a} \\cdot 1 = ${coeff.a} \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.b}) = 0 \\]`,
                    `Combine: \\[ \\frac{dy}{dx} = ${coeff.a} \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{1}{${coeff.a}}`,
                solution: (coeff, C) => `y = -\\frac{x}{${coeff.a}} + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = ${coeff.a} \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot ${coeff.a} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{1}{${coeff.a}} \\]`,
                    `Separable equation: \\[ dy = -\\frac{dx}{${coeff.a}} \\]`,
                    `Integrate: \\[ \\int dy = -\\frac{1}{${coeff.a}} \\int dx \\]`,
                    `\\[ y = -\\frac{x}{${coeff.a}} + ${C} \\]`
                ]
            },

            'cubic': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\*?\s*x\s*\^\s*3\s*([+-]\s*\d*\.?\d*)\s*\*?\s*x\s*\^\s*2\s*([+-]\s*\d*\.?\d*)\s*\*?\s*x\s*([+-]\s*\d*\.?\d*)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\*?\s*x\s*\^\s*3/i,
                template: 'y = a·x³ + b·x² + p·x + d',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    b: parseFloat(match[2].replace(/\s/g, '')) || 0,
                    p: parseFloat(match[3].replace(/\s/g, '')) || 0,
                    d: parseFloat(match[4].replace(/\s/g, '')) || 0
                }),
                derivative: (coeff) => `3 \\cdot ${coeff.a}x^2 + 2 \\cdot ${coeff.b}x + ${coeff.p}`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}x^3 + ${coeff.b}x^2 + ${coeff.p}x + ${coeff.d} \\]`,
                    `Apply power rule: \\[ \\frac{d}{dx}(x^n) = n \\cdot x^{n-1} \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.a}x^3) = 3 \\cdot ${coeff.a}x^{3-1} = ${3 * coeff.a}x^2 \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.b}x^2) = 2 \\cdot ${coeff.b}x^{2-1} = ${2 * coeff.b}x \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.p}x) = ${coeff.p} \\]`,
                    `\\[ \\frac{d}{dx}(${coeff.d}) = 0 \\]`,
                    `Combine: \\[ \\frac{dy}{dx} = ${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p} \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{1}{${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p}}`,
                solution: (coeff, C) => `y = -\\int \\frac{dx}{${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p}} + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = ${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p} \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{1}{${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p}} \\]`,
                    `Separable equation: \\[ dy = -\\frac{dx}{${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p}} \\]`,
                    `Integral form: \\[ y = -\\int \\frac{dx}{${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p}} + ${C} \\]`,
                    `Complete the square in denominator:`,
                    `\\[ ${3 * coeff.a}x^2 + ${2 * coeff.b}x + ${coeff.p} = ${3 * coeff.a}\\left(x^2 + \\frac{${2 * coeff.b}}{${3 * coeff.a}}x\\right) + ${coeff.p} \\]`,
                    `Solution depends on discriminant \\[ D = (${2 * coeff.b})^2 - 4 \\cdot (${3 * coeff.a}) \\cdot (${coeff.p}) \\]`
                ]
            },

            'power': {
                pattern: /y\s*=\s*x\s*\^\s*([+-]?\d*\.?\d*)/i,
                test: /y\s*=\s*x\s*\^\s*[+-]?\d*\.?\d*/i,
                template: 'y = xⁿ',
                parse: (match) => ({
                    n: parseFloat(match[1]) || 1
                }),
                derivative: (coeff) => `${coeff.n} \\cdot x^{${coeff.n - 1}}`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = x^{${coeff.n}} \\]`,
                    `Apply power rule: \\[ \\frac{d}{dx}(x^n) = n \\cdot x^{n-1} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.n} \\cdot x^{${coeff.n}-1} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.n}x^{${coeff.n - 1}} \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{1}{${coeff.n} \\cdot x^{${coeff.n - 1}}}`,
                solution: (coeff, C) => {
                    if (coeff.n === 2) {
                        return `y = -\\frac{1}{2} \\ln|x| + ${C}`;
                    }
                    return `y = -\\frac{x^{${2 - coeff.n}}}{${coeff.n}(${2 - coeff.n})} + ${C}`;
                },
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = ${coeff.n}x^{${coeff.n - 1}} \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{1}{${coeff.n}x^{${coeff.n - 1}}} \\]`,
                    `Simplify: \\[ \\frac{dy}{dx} = -\\frac{1}{${coeff.n}} x^{${1 - coeff.n}} \\]`,
                    `Separable equation: \\[ dy = -\\frac{1}{${coeff.n}} x^{${1 - coeff.n}} dx \\]`,
                    `Integrate: \\[ \\int dy = -\\frac{1}{${coeff.n}} \\int x^{${1 - coeff.n}} dx \\]`,
                    coeff.n === 2 
                        ? `For n = 2: \\[ y = -\\frac{1}{2} \\ln|x| + ${C} \\]`
                        : `\\[ y = -\\frac{x^{${2 - coeff.n}}}{${coeff.n}(${2 - coeff.n})} + ${C} \\]`
                ]
            },

            // ========== TRIGONOMETRIC FUNCTIONS ==========
            'sine': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\*?\s*sin\s*\(\s*([+-]?\d*\.?\d*)\s*\*?\s*x\s*\)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\*?\s*sin/i,
                template: 'y = a·sin(b·x)',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    b: parseFloat(match[2]) || 1
                }),
                derivative: (coeff) => `${coeff.a} \\cdot ${coeff.b} \\cdot \\cos(${coeff.b}x)`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}\\sin(${coeff.b}x) \\]`,
                    `Apply chain rule: \\[ \\frac{d}{dx}\\sin(u) = \\cos(u) \\cdot \\frac{du}{dx} \\]`,
                    `Let \\[ u = ${coeff.b}x, \\quad \\frac{du}{dx} = ${coeff.b} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a} \\cdot \\cos(u) \\cdot ${coeff.b} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a} \\cdot ${coeff.b} \\cdot \\cos(${coeff.b}x) \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a * coeff.b}\\cos(${coeff.b}x) \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{1}{${coeff.a} \\cdot ${coeff.b} \\cdot \\cos(${coeff.b}x)}`,
                solution: (coeff, C) => `y = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}^2} \\ln|\\sec(${coeff.b}x) + \\tan(${coeff.b}x)| + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = ${coeff.a} \\cdot ${coeff.b} \\cdot \\cos(${coeff.b}x) \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{1}{${coeff.a} \\cdot ${coeff.b} \\cdot \\cos(${coeff.b}x)} \\]`,
                    `\\[ \\frac{dy}{dx} = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}} \\cdot \\sec(${coeff.b}x) \\]`,
                    `Separable equation: \\[ dy = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}} \\cdot \\sec(${coeff.b}x) dx \\]`,
                    `Integrate using standard formula: \\[ \\int \\sec(ax) dx = \\frac{1}{a} \\ln|\\sec(ax) + \\tan(ax)| \\]`,
                    `\\[ y = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}} \\cdot \\frac{1}{${coeff.b}} \\ln|\\sec(${coeff.b}x) + \\tan(${coeff.b}x)| + ${C} \\]`,
                    `\\[ y = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}^2} \\ln|\\sec(${coeff.b}x) + \\tan(${coeff.b}x)| + ${C} \\]`
                ]
            },

            'cosine': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\*?\s*cos\s*\(\s*([+-]?\d*\.?\d*)\s*\*?\s*x\s*\)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\*?\s*cos/i,
                template: 'y = a·cos(b·x)',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    b: parseFloat(match[2]) || 1
                }),
                derivative: (coeff) => `-${coeff.a} \\cdot ${coeff.b} \\cdot \\sin(${coeff.b}x)`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}\\cos(${coeff.b}x) \\]`,
                    `Apply chain rule: \\[ \\frac{d}{dx}\\cos(u) = -\\sin(u) \\cdot \\frac{du}{dx} \\]`,
                    `Let \\[ u = ${coeff.b}x, \\quad \\frac{du}{dx} = ${coeff.b} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a} \\cdot (-\\sin(u)) \\cdot ${coeff.b} \\]`,
                    `\\[ \\frac{dy}{dx} = -${coeff.a} \\cdot ${coeff.b} \\cdot \\sin(${coeff.b}x) \\]`,
                    `\\[ \\frac{dy}{dx} = -${coeff.a * coeff.b}\\sin(${coeff.b}x) \\]`
                ],
                orthogonalSlope: (coeff) => `\\frac{1}{${coeff.a} \\cdot ${coeff.b} \\cdot \\sin(${coeff.b}x)}`,
                solution: (coeff, C) => `y = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}^2} \\ln|\\csc(${coeff.b}x) + \\cot(${coeff.b}x)| + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = -${coeff.a} \\cdot ${coeff.b} \\cdot \\sin(${coeff.b}x) \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = \\frac{1}{${coeff.a} \\cdot ${coeff.b} \\cdot \\sin(${coeff.b}x)} \\]`,
                    `\\[ \\frac{dy}{dx} = \\frac{1}{${coeff.a} \\cdot ${coeff.b}} \\cdot \\csc(${coeff.b}x) \\]`,
                    `Separable equation: \\[ dy = \\frac{1}{${coeff.a} \\cdot ${coeff.b}} \\cdot \\csc(${coeff.b}x) dx \\]`,
                    `Integrate using standard formula: \\[ \\int \\csc(ax) dx = -\\frac{1}{a} \\ln|\\csc(ax) + \\cot(ax)| \\]`,
                    `\\[ y = \\frac{1}{${coeff.a} \\cdot ${coeff.b}} \\cdot \\left(-\\frac{1}{${coeff.b}}\\right) \\ln|\\csc(${coeff.b}x) + \\cot(${coeff.b}x)| + ${C} \\]`,
                    `\\[ y = -\\frac{1}{${coeff.a} \\cdot ${coeff.b}^2} \\ln|\\csc(${coeff.b}x) + \\cot(${coeff.b}x)| + ${C} \\]`
                ]
            },

            // ========== EXPONENTIAL FUNCTIONS ==========
            'exponential': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\^\s*x/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\^\s*x/i,
                template: 'y = aˣ',
                parse: (match) => ({
                    a: parseFloat(match[1]) || Math.E
                }),
                derivative: (coeff) => `${coeff.a}^x \\cdot \\ln(${coeff.a})`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}^x \\]`,
                    `Rewrite using natural base: \\[ y = e^{\\ln(${coeff.a}) \\cdot x} \\]`,
                    `Apply chain rule: \\[ \\frac{d}{dx}e^{u} = e^{u} \\cdot \\frac{du}{dx} \\]`,
                    `Let \\[ u = \\ln(${coeff.a}) \\cdot x, \\quad \\frac{du}{dx} = \\ln(${coeff.a}) \\]`,
                    `\\[ \\frac{dy}{dx} = e^{\\ln(${coeff.a}) \\cdot x} \\cdot \\ln(${coeff.a}) \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a}^x \\cdot \\ln(${coeff.a}) \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{1}{${coeff.a}^x \\cdot \\ln(${coeff.a})}`,
                solution: (coeff, C) => `y = -\\frac{${coeff.a}^{-x}}{\\ln(${coeff.a}) \\cdot \\ln(${coeff.a})} + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = ${coeff.a}^x \\cdot \\ln(${coeff.a}) \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{1}{${coeff.a}^x \\cdot \\ln(${coeff.a})} \\]`,
                    `\\[ \\frac{dy}{dx} = -\\frac{${coeff.a}^{-x}}{\\ln(${coeff.a})} \\]`,
                    `Separable equation: \\[ dy = -\\frac{${coeff.a}^{-x}}{\\ln(${coeff.a})} dx \\]`,
                    `Integrate using substitution: \\[ u = -x \\cdot \\ln(${coeff.a}), \\quad du = -\\ln(${coeff.a}) dx \\]`,
                    `\\[ \\int ${coeff.a}^{-x} dx = \\int e^{-x\\ln(${coeff.a})} dx = -\\frac{e^{-x\\ln(${coeff.a})}}{\\ln(${coeff.a})} \\]`,
                    `\\[ y = -\\frac{${coeff.a}^{-x}}{\\ln(${coeff.a}) \\cdot \\ln(${coeff.a})} + ${C} \\]`
                ]
            },

            // ========== LOGARITHMIC FUNCTIONS ==========
            'logarithm': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\*?\s*ln\s*\(\s*([+-]?\d*\.?\d*)\s*\*?\s*x\s*\)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\*?\s*ln/i,
                template: 'y = a·ln(b·x)',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    b: parseFloat(match[2]) || 1
                }),
                derivative: (coeff) => `\\frac{${coeff.a}}{x}`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = ${coeff.a}\\ln(${coeff.b}x) \\]`,
                    `Apply chain rule: \\[ \\frac{d}{dx}\\ln(u) = \\frac{1}{u} \\cdot \\frac{du}{dx} \\]`,
                    `Let \\[ u = ${coeff.b}x, \\quad \\frac{du}{dx} = ${coeff.b} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a} \\cdot \\frac{1}{${coeff.b}x} \\cdot ${coeff.b} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a} \\cdot \\frac{${coeff.b}}{${coeff.b}x} \\]`,
                    `\\[ \\frac{dy}{dx} = \\frac{${coeff.a}}{x} \\]`
                ],
                orthogonalSlope: (coeff) => `-\\frac{x}{${coeff.a}}`,
                solution: (coeff, C) => `y = -\\frac{x^2}{${2 * coeff.a}} + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = \\frac{${coeff.a}}{x} \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = -\\frac{x}{${coeff.a}} \\]`,
                    `Separable equation: \\[ dy = -\\frac{x}{${coeff.a}} dx \\]`,
                    `Integrate: \\[ \\int dy = -\\frac{1}{${coeff.a}} \\int x dx \\]`,
                    `\\[ y = -\\frac{1}{${coeff.a}} \\cdot \\frac{x^2}{2} + ${C} \\]`,
                    `\\[ y = -\\frac{x^2}{${2 * coeff.a}} + ${C} \\]`
                ]
            },

            // ========== RATIONAL FUNCTIONS ==========
            'rational_power': {
                pattern: /y\s*=\s*([+-]?\d*\.?\d*)\s*\/\s*x\s*\^\s*([+-]?\d*\.?\d*)/i,
                test: /y\s*=\s*[+-]?\d*\.?\d*\s*\/\s*x\s*\^\s*[+-]?\d*\.?\d*/i,
                template: 'y = a/xⁿ',
                parse: (match) => ({
                    a: parseFloat(match[1]) || 1,
                    n: parseFloat(match[2]) || 1
                }),
                derivative: (coeff) => `-${coeff.a} \\cdot ${coeff.n} \\cdot x^{-${coeff.n + 1}}`,
                derivativeExplanation: (coeff) => [
                    `Given: \\[ y = \\frac{${coeff.a}}{x^{${coeff.n}}} = ${coeff.a}x^{-${coeff.n}} \\]`,
                    `Apply power rule: \\[ \\frac{d}{dx}(x^n) = n \\cdot x^{n-1} \\]`,
                    `\\[ \\frac{dy}{dx} = ${coeff.a} \\cdot (-${coeff.n}) \\cdot x^{-${coeff.n}-1} \\]`,
                    `\\[ \\frac{dy}{dx} = -${coeff.a} \\cdot ${coeff.n} \\cdot x^{-${coeff.n + 1}} \\]`,
                    `\\[ \\frac{dy}{dx} = -\\frac{${coeff.a} \\cdot ${coeff.n}}{x^{${coeff.n + 1}}} \\]`
                ],
                orthogonalSlope: (coeff) => `\\frac{x^{${coeff.n + 1}}}{${coeff.a} \\cdot ${coeff.n}}`,
                solution: (coeff, C) => `y = \\frac{x^{${coeff.n + 2}}}{${coeff.a} \\cdot ${coeff.n} \\cdot (${coeff.n + 2})} + ${C}`,
                steps: (coeff, C) => [
                    `Original derivative: \\[ \\frac{dy}{dx} = -\\frac{${coeff.a} \\cdot ${coeff.n}}{x^{${coeff.n + 1}}} \\]`,
                    `Orthogonal condition: \\[ m_{\\text{orth}} \\cdot m_{\\text{orig}} = -1 \\]`,
                    `Orthogonal slope: \\[ \\frac{dy}{dx} = \\frac{x^{${coeff.n + 1}}}{${coeff.a} \\cdot ${coeff.n}} \\]`,
                    `Separable equation: \\[ dy = \\frac{x^{${coeff.n + 1}}}{${coeff.a} \\cdot ${coeff.n}} dx \\]`,
                    `Integrate: \\[ \\int dy = \\frac{1}{${coeff.a} \\cdot ${coeff.n}} \\int x^{${coeff.n + 1}} dx \\]`,
                    `\\[ y = \\frac{1}{${coeff.a} \\cdot ${coeff.n}} \\cdot \\frac{x^{${coeff.n + 2}}}{${coeff.n + 2}} + ${C} \\]`,
                    `\\[ y = \\frac{x^{${coeff.n + 2}}}{${coeff.a} \\cdot ${coeff.n} \\cdot (${coeff.n + 2})} + ${C} \\]`
                ]
            }
        };

        // Insert equation into input field
        function insertEquation(equation) {
            equationInput.value = equation;
            equationInput.focus();
            hideMessages();
            showCoefficientInputs(equation);
        }

        // Show coefficient inputs
        function showCoefficientInputs(equation) {
            const detected = detectEquationType(equation);
            coeffInputs.innerHTML = '';
            
            if (!detected || !detected.coefficients) {
                coeffInputs.style.display = 'none';
                return;
            }
            
            coeffInputs.style.display = 'grid';
            
            for (const [coeff, value] of Object.entries(detected.coefficients)) {
                const group = document.createElement('div');
                group.className = 'coeff-group';
                group.innerHTML = `
                    <label class="coeff-label">${coeff.toUpperCase()}</label>
                    <input type="number" class="coeff-input" id="coeff_${coeff}" 
                           value="${value}" step="0.1" placeholder="${coeff}">
                `;
                coeffInputs.appendChild(group);
            }
        }

        // Get coefficients from inputs
        function getCoefficients() {
            const inputs = coeffInputs.querySelectorAll('.coeff-input');
            const coeffs = {};
            
            inputs.forEach(input => {
                const name = input.id.replace('coeff_', '');
                coeffs[name] = parseFloat(input.value) || 0;
            });
            
            return coeffs;
        }

        // Detect equation type
        function detectEquationType(equation) {
            for (const [type, pattern] of Object.entries(equationPatterns)) {
                const match = equation.match(pattern.pattern);
                if (match) {
                    return {
                        type: type,
                        coefficients: pattern.parse(match),
                        pattern: pattern
                    };
                }
            }
            
            // Try simplified patterns
            const eq = equation.replace(/\s/g, '').toLowerCase();
            
            if (eq.includes('y=x^2') || eq.includes('y=x²')) {
                return {
                    type: 'quadratic',
                    coefficients: {a: 1, b: 0, p: 0},
                    pattern: equationPatterns.quadratic
                };
            } else if (eq.includes('y=ln(x)')) {
                return {
                    type: 'logarithm',
                    coefficients: {a: 1, b: 1},
                    pattern: equationPatterns.logarithm
                };
            } else if (eq.includes('y=sin(x)')) {
                return {
                    type: 'sine',
                    coefficients: {a: 1, b: 1},
                    pattern: equationPatterns.sine
                };
            } else if (eq.includes('y=cos(x)')) {
                return {
                    type: 'cosine',
                    coefficients: {a: 1, b: 1},
                    pattern: equationPatterns.cosine
                };
            } else if (eq.includes('y=e^x')) {
                return {
                    type: 'exponential',
                    coefficients: {a: Math.E},
                    pattern: equationPatterns.exponential
                };
            } else if (eq.includes('y=1/x')) {
                return {
                    type: 'rational_power',
                    coefficients: {a: 1, n: 1},
                    pattern: equationPatterns.rational_power
                };
            }
            
            return null;
        }

        // Error handling
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // Loading states
        function showLoading() {
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
            calculateBtn.disabled = true;
        }

        function hideLoading() {
            calculateBtn.innerHTML = '<i class="fas fa-bolt"></i> Calculate Orthogonal Trajectory';
            calculateBtn.disabled = false;
        }

        // Main calculation
        calculateBtn.addEventListener('click', function() {
            const equation = equationInput.value.trim();
            const constant = 'C'; // Integration constant
            
            if (!equation) {
                showError('Please enter an equation');
                return;
            }

            hideMessages();
            showLoading();
            
            try {
                const detected = detectEquationType(equation);
                
                if (!detected) {
                    showError('Unable to recognize equation format. Please use standard notation.');
                    hideLoading();
                    return;
                }
                
                const pattern = detected.pattern;
                const coefficients = getCoefficients();
                
                // Generate solution
                const solution = {
                    derivative: pattern.derivative(coefficients),
                    derivativeExplanation: pattern.derivativeExplanation(coefficients),
                    orthogonalSlope: pattern.orthogonalSlope(coefficients),
                    solution: pattern.solution(coefficients, constant),
                    steps: pattern.steps(coefficients, constant)
                };
                
                showSuccess('Solution found successfully!');
                
                // Update solution display
                updateSolutionDisplay(equation, detected.type, coefficients, solution);
                
                // Generate graphs
                generateGraphs(detected.type, coefficients, constant);
                
                // Show results page
                setTimeout(() => {
                    frontPage.style.display = 'none';
                    backendPage.style.display = 'block';
                    window.scrollTo(0, 0);
                    hideLoading();
                }, 500);
                
            } catch (error) {
                showError('Error: ' + error.message);
                hideLoading();
            }
        });

        // Update solution display
        function updateSolutionDisplay(equation, type, coefficients, solution) {
            // Original equation
            document.getElementById('originalEquationDisplay').innerHTML = `\\[ ${equation} \\]`;
            
            // Parameters
            const paramsDisplay = document.getElementById('paramsDisplay');
            paramsDisplay.innerHTML = `<div style="background:#f0f0f0; padding:10px; border-radius:5px; margin-top:10px;">
                <strong>Parameters:</strong><br>${JSON.stringify(coefficients, null, 2).replace(/"/g, '')}
            </div>`;
            
            // Derivative display
            document.getElementById('derivativeDisplay').innerHTML = 
                `\\[ \\frac{dy}{dx} = ${solution.derivative} \\]`;
            
            // Differentiation steps
            const diffStepsDiv = document.getElementById('differentiationSteps');
            diffStepsDiv.innerHTML = solution.derivativeExplanation.map((step, index) => `
                <div class="step">
                    <span class="step-number">${index + 1}</span>
                    ${step}
                </div>
            `).join('');
            
            // Orthogonal trajectory steps
            const orthoStepsDiv = document.getElementById('orthogonalSteps');
            orthoStepsDiv.innerHTML = solution.steps.map((step, index) => `
                <div class="step">
                    <span class="step-number">${index + 1}</span>
                    ${step}
                </div>
            `).join('');
            
            // Final answer
            document.getElementById('finalAnswer').innerHTML = `\\[ ${solution.solution} \\]`;
            
            // Render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // Generate graphs
        function generateGraphs(type, coefficients, constant) {
            // Clear previous graphs
            Plotly.purge('originalGraph');
            Plotly.purge('orthogonalGraph');
            Plotly.purge('combinedGraph');
            
            // Generate data
            const xValues = [];
            for (let x = -5; x <= 5; x += 0.1) {
                xValues.push(x);
            }
            
            // Original function values
            const yOriginal = xValues.map(x => evaluateFunction(type, coefficients, x));
            
            // Orthogonal trajectories with different constants
            const constants = [-2, -1, 0, 1, 2];
            const orthogonalTraces = constants.map(C => {
                const yOrtho = xValues.map(x => evaluateOrthogonalFunction(type, coefficients, x, C));
                return {
                    x: xValues,
                    y: yOrtho,
                    mode: 'lines',
                    name: `C = ${C}`,
                    line: {color: '#ef5350', width: 2, dash: C === 0 ? 'solid' : 'dash'}
                };
            });
            
            // Graph configuration
            const config = {displayModeBar: false, responsive: true};
            
            // Original function graph
            Plotly.newPlot('originalGraph', [{
                x: xValues,
                y: yOriginal,
                mode: 'lines',
                name: 'Original',
                line: {color: '#5c6bc0', width: 3}
            }], {
                title: 'Original Function',
                xaxis: {title: 'x'},
                yaxis: {title: 'y'},
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            }, config);
            
            // Orthogonal trajectories graph
            Plotly.newPlot('orthogonalGraph', orthogonalTraces, {
                title: 'Orthogonal Trajectories',
                xaxis: {title: 'x'},
                yaxis: {title: 'y'},
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                showlegend: true
            }, config);
            
            // Combined graph
            Plotly.newPlot('combinedGraph', [
                {
                    x: xValues,
                    y: yOriginal,
                    mode: 'lines',
                    name: 'Original',
                    line: {color: '#5c6bc0', width: 3}
                },
                orthogonalTraces[2] // C = 0
            ], {
                title: 'Original Function and Orthogonal Trajectory (C=0)',
                xaxis: {title: 'x'},
                yaxis: {title: 'y'},
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                showlegend: true
            }, config);
        }

        // Evaluate function
        function evaluateFunction(type, coefficients, x) {
            try {
                switch(type) {
                    case 'quadratic':
                        return coefficients.a * x * x + coefficients.b * x + coefficients.p;
                    case 'linear':
                        return coefficients.a * x + coefficients.b;
                    case 'cubic':
                        return coefficients.a * x * x * x + coefficients.b * x * x + coefficients.p * x + (coefficients.d || 0);
                    case 'power':
                        return Math.pow(x, coefficients.n);
                    case 'sine':
                        return coefficients.a * Math.sin(coefficients.b * x);
                    case 'cosine':
                        return coefficients.a * Math.cos(coefficients.b * x);
                    case 'exponential':
                        return Math.pow(coefficients.a, x);
                    case 'logarithm':
                        return coefficients.a * Math.log(coefficients.b * x);
                    case 'rational_power':
                        return coefficients.a / Math.pow(x, coefficients.n);
                    default:
                        return Math.sin(x);
                }
            } catch (e) {
                return null;
            }
        }

        // Evaluate orthogonal function
        function evaluateOrthogonalFunction(type, coefficients, x, C) {
            try {
                switch(type) {
                    case 'quadratic':
                        return -Math.log(Math.abs(2 * coefficients.a * x + coefficients.b)) / (2 * coefficients.a) + C;
                    case 'linear':
                        return -x / coefficients.a + C;
                    case 'power':
                        if (coefficients.n === 2) {
                            return -0.5 * Math.log(Math.abs(x)) + C;
                        }
                        return -Math.pow(x, 2 - coefficients.n) / (coefficients.n * (2 - coefficients.n)) + C;
                    case 'sine':
                        return -Math.log(Math.abs(1/Math.cos(coefficients.b * x) + Math.tan(coefficients.b * x))) / (coefficients.a * coefficients.b * coefficients.b) + C;
                    case 'cosine':
                        return -Math.log(Math.abs(1/Math.sin(coefficients.b * x) + 1/Math.tan(coefficients.b * x))) / (coefficients.a * coefficients.b * coefficients.b) + C;
                    case 'exponential':
                        return -Math.pow(coefficients.a, -x) / (Math.log(coefficients.a) * Math.log(coefficients.a)) + C;
                    case 'logarithm':
                        return -x * x / (2 * coefficients.a) + C;
                    case 'rational_power':
                        return Math.pow(x, coefficients.n + 2) / (coefficients.a * coefficients.n * (coefficients.n + 2)) + C;
                    default:
                        return -0.5 * Math.log(Math.abs(x)) + C;
                }
            } catch (e) {
                return null;
            }
        }

        // Back to home
        backHomeBtn.addEventListener('click', function() {
            backendPage.style.display = 'none';
            frontPage.style.display = 'block';
            window.scrollTo(0, 0);
            hideMessages();
        });

        // Initialize
        window.onload = function() {
            // Animate equation examples
            const examples = [
                "y = 2·x² + 3·x + 1",
                "y = 2·sin(3·x)",
                "y = 2ˣ",
                "y = 2·ln(3·x)",
                "y = 1/x²"
            ];
            let idx = 0;
            
            function animateEquation() {
                const mainEq = document.getElementById('mainEquation');
                const orthoEq = document.getElementById('orthogonalEquation');
                
                const eq = examples[idx];
                mainEq.innerHTML = `\\[ ${eq} \\]`;
                
                idx = (idx + 1) % examples.length;
                
                if (window.MathJax) {
                    MathJax.typesetPromise();
                }
                
                setTimeout(animateEquation, 3000);
            }
            
            animateEquation();
            
            // Show coefficient inputs when equation changes
            equationInput.addEventListener('input', function() {
                showCoefficientInputs(this.value);
            });
            
            // Enter key support
            equationInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateBtn.click();
                }
            });
        };

        // Render MathJax
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    </script>
</body>
</html>
